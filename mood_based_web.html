<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mood-Based Web Experience ‚Äî Ultra Edition</title>
<style>
  /* ---------- Base & Fonts ---------- */
  :root{
    --glass: rgba(255,255,255,0.08);
    --glass-2: rgba(255,255,255,0.06);
    --txt: #fff;
    --accent: #ffd7a8;
    --soft-shadow: 0 8px 30px rgba(220,140,70,0.12);
  }
  *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue";}

  html,body{
    height:100%;
    background: radial-gradient(circle at 10% 20%, #fff0c8 0%, transparent 12%),
                radial-gradient(circle at 90% 80%, #ffd6b0 0%, transparent 14%),
                linear-gradient(180deg,#ffedd8 0%, #ffd1a3 40%, #ffb07a 100%);
    transition: background 900ms ease;
    -webkit-font-smoothing:antialiased;
    color:var(--txt);
    overflow:hidden;
  }

  /* ---------- Layout ---------- */
  .wrap{
    position:relative;
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:40px;
    gap:24px;
  }

  .card{
    width:100%;
    max-width:1100px;
    background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
    border-radius:20px;
    box-shadow: var(--soft-shadow), 0 2px 0 rgba(255,255,255,0.03) inset;
    backdrop-filter: blur(14px) saturate(120%);
    display:grid;
    grid-template-columns: 420px 1fr;
    padding:28px;
    gap:22px;
    position:relative;
    overflow:visible;
  }

  /* ---------- LEFT PANEL ---------- */
  .panel-left{
    padding:20px;
    border-radius:14px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    display:flex;
    flex-direction:column;
    gap:16px;
    align-items:center;
    justify-content:flex-start;
    position:relative;
  }

  .logo{
    width:90%;
    text-align:center;
    margin-bottom:2px;
  }
  .logo h1{
    font-size:20px;
    letter-spacing:0.2px;
    color:var(--txt);
    text-shadow:0 6px 22px rgba(255,170,80,0.12);
  }
  .greeting{
    color:var(--txt);
    opacity:0.9;
    font-size:13px;
  }

  .main-card{
    width:100%;
    border-radius:14px;
    padding:14px;
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:flex-start;
    background: linear-gradient(180deg, rgba(255,255,255,0.025), rgba(255,255,255,0.02));
    box-shadow: 0 8px 30px rgba(255,160,80,0.06);
  }

  .avatar{
    width:84px;height:84px;border-radius:14px;
    background:linear-gradient(135deg,#fff6e7,#ffd6a3);
    display:flex;align-items:center;justify-content:center;font-size:36px;
    box-shadow: 0 8px 30px rgba(255,200,120,0.08), inset 0 -6px 14px rgba(0,0,0,0.03);
  }

  .intro{
    flex:1;
  }
  .intro h2{font-size:18px;margin-bottom:4px;}
  .intro p{font-size:13px;opacity:0.85;line-height:1.2;}

  /* ---------- Mood buttons ---------- */
  .mood-grid{
    width:100%;
    display:grid;
    grid-template-columns:repeat(2,1fr);
    gap:12px;
    margin-top:6px;
  }
  .mood-btn{
    padding:12px 10px;border-radius:12px;border:none;cursor:pointer;
    font-weight:700;color:#111;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    display:flex;gap:10px;align-items:center;justify-content:flex-start;
    transition:transform 240ms ease, box-shadow 240ms ease;
    user-select:none;
  }
  .mood-btn:hover{ transform:translateY(-6px); box-shadow:0 18px 36px rgba(0,0,0,0.09); }
  .mood-emoji{ font-size:20px; width:44px; text-align:center; }
  .mood-label{ font-size:15px; color: #111; opacity:0.95; }

  /* ---------- Controls ---------- */
  .controls{
    width:100%;
    margin-top:8px;
    display:flex;gap:10px;flex-direction:column;
  }
  .row{
    display:flex;gap:8px;align-items:center;
  }
  .toggle{
    margin-left:auto;display:flex;gap:8px;align-items:center;font-size:13px;opacity:0.92;
  }
  .music-toggle{
    width:44px;height:26px;border-radius:999px;background:linear-gradient(180deg,#ffffff22,#00000005);
    position:relative;padding:3px;cursor:pointer;
  }
  .switch-dot{
    width:18px;height:18px;border-radius:14px;background:#fff;position:absolute;left:3px;top:3px;transition:left 220ms ease;
    box-shadow:0 6px 18px rgba(0,0,0,0.12);
  }
  .music-toggle.on .switch-dot{ left:23px; }

  .slider{
    -webkit-appearance:none;width:100%;height:6px;border-radius:999px;background:linear-gradient(90deg,#fff4c2,#ffd1a0);
    outline:none;
  }

  /* ---------- RIGHT PANEL (visual + messages) ---------- */
  .panel-right{
    padding:20px;border-radius:14px;
    position:relative;
    overflow:hidden;
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  /* floating canvas area */
  .visual-area{
    flex:1;border-radius:12px;position:relative;overflow:hidden;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    box-shadow: 0 18px 40px rgba(255,160,70,0.05);
    display:flex;align-items:center;justify-content:center;
  }

  /* mood message */
  .mood-message{
    position:relative;padding:14px;border-radius:12px;background:linear-gradient(180deg,rgba(0,0,0,0.06), rgba(255,255,255,0.02));
    display:flex;gap:12px;align-items:center;justify-content:space-between;
  }
  .mood-title{
    font-size:18px;font-weight:700;
  }
  .mood-sub{
    font-size:13px;opacity:0.85;
  }

  /* quotes */
  .quotes { font-size:13px; opacity:0.9; font-style:italic; margin-top:6px; text-align:center; }

  /* footer controls */
  .footer{
    display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:6px;
  }

  .btn{
    padding:10px 14px;border-radius:10px;background:linear-gradient(180deg,#fff6e7,#ffd6a3);
    border:none;font-weight:700;cursor:pointer; box-shadow:0 12px 30px rgba(255,156,60,0.08);
  }

  /* small responsive */
  @media (max-width:980px){
    .card{grid-template-columns:1fr; padding:18px;}
    .wrap{padding:18px;}
  }

  /* subtle animations */
  @keyframes floaty {
    0%{ transform: translateY(0px) rotate(0deg) }
    50%{ transform: translateY(-8px) rotate(3deg) }
    100%{ transform: translateY(0px) rotate(0deg) }
  }
  .avatar{ animation: floaty 4s ease-in-out infinite; }

  /* ring element */
  .ring {
    position:absolute; border-radius:999px; pointer-events:none;
    mix-blend-mode:screen; filter:blur(26px); opacity:0.9;
  }

  /* typewriter */
  .typewriter { font-weight:600; font-size:15px; letter-spacing:0.2px; }

</style>
</head>
<body>
<div class="wrap">
  <div class="card" id="card">
    <div class="panel-left">
      <div class="logo">
        <h1>Mood Studio ‚Äî Warm Glowing Edition</h1>
        <div class="greeting" id="greeting">Welcome</div>
      </div>

      <div class="main-card">
        <div class="avatar" id="avatar">‚ú®</div>
        <div class="intro">
          <h2 id="username">Hello, Friend</h2>
          <p id="tagline">Choose a mood ‚Äî the whole page will glow with it. ‚ú®</p>
        </div>
      </div>

      <div class="mood-grid" id="moodGrid">
        <button class="mood-btn" data-mood="happy"><div class="mood-emoji">üòä</div><div class="mood-label">Happy</div></button>
        <button class="mood-btn" data-mood="calm"><div class="mood-emoji">üòå</div><div class="mood-label">Calm</div></button>
        <button class="mood-btn" data-mood="focus"><div class="mood-emoji">üéØ</div><div class="mood-label">Focus</div></button>
        <button class="mood-btn" data-mood="warm"><div class="mood-emoji">üíõ</div><div class="mood-label">Warm</div></button>
      </div>

      <div class="controls">
        <div class="row">
          <div style="font-size:13px;opacity:0.9;">Music</div>
          <div class="toggle" title="Toggle background audio">
            <div class="music-toggle" id="musicToggle" role="switch" aria-checked="false"><div class="switch-dot"></div></div>
            <div style="font-size:13px;opacity:0.9;">On / Off</div>
          </div>
        </div>

        <div class="row" style="align-items:center;">
          <div style="font-size:13px;opacity:0.95;">Intensity</div>
          <input id="intensity" class="slider" type="range" min="0" max="100" value="60" />
        </div>

        <div class="row" style="align-items:center;">
          <div style="font-size:13px;opacity:0.95;">Auto-save</div>
          <div style="margin-left:auto;font-size:13px;opacity:0.9;" id="autosaveState">Enabled</div>
        </div>
      </div>
    </div>

    <div class="panel-right">
      <div class="visual-area" id="visualArea">
        <!-- canvas for particles -->
        <canvas id="particlesCanvas" style="position:absolute;inset:0;display:block;"></canvas>
        <!-- glowing rings -->
        <div id="ringsContainer" style="position:absolute;inset:0;pointer-events:none;"></div>

        <!-- center content -->
        <div style="position:relative;z-index:2;display:flex;flex-direction:column;align-items:center;gap:10px;">
          <div style="text-align:center;">
            <div class="typewriter" id="typewriter">Pick a mood to begin...</div>
            <div style="margin-top:6px;font-size:12px;opacity:0.85;" id="timeNote">A little calm and warmth for your day.</div>
          </div>
        </div>
      </div>

      <div class="mood-message" id="moodMessage">
        <div>
          <div class="mood-title" id="moodTitle">Mood: ‚Äî</div>
          <div class="mood-sub" id="moodSub">Message will appear here.</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;align-items:center;">
          <div style="font-size:22px;" id="bigEmoji">‚ú®</div>
          <div style="font-size:12px;opacity:0.85;">Intensity: <span id="intensityVal">60</span>%</div>
        </div>
      </div>

      <div class="quotes" id="quoteArea">‚ÄúTiny warm things make big days.‚Äù</div>

      <div class="footer">
        <div style="display:flex;gap:8px;">
          <button class="btn" id="saveBtn">Save Mood (local)</button>
          <button class="btn" id="restoreBtn">Restore</button>
        </div>
        <div>
          <button class="btn" id="randomBtn">Surprise Me</button>
        </div>
      </div>
    </div>

    <!-- decorative ring to give glow -->
    <div id="decorRing" class="ring" style="width:360px;height:360px;left:24px;top:-120px;background:radial-gradient(circle,#ffd6a6,transparent 40%);opacity:0.7;"></div>
  </div>
</div>

<script>
/* ========== State & Assets ========== */
const moods = {
  happy: {
    title: "Happy",
    subtitle: "Your joy brightens everything ‚Äî share a smile!",
    emoji: "üòä",
    bg: ["#fff7e1","#ffd5a1","#ffb36b"],
    particleColor: "#FFD77A",
    ring: { size: 420, color: "rgba(255,200,110,0.12)" },
    audio: { type: "pluck", tempo: 1.05 }
  },
  calm: {
    title: "Calm",
    subtitle: "Deep breaths. Slow and steady ‚Äî you‚Äôre doing fine.",
    emoji: "üòå",
    bg: ["#e7fbff","#d0f0ff","#a7e6ff"],
    particleColor: "#99E6FF",
    ring: { size: 520, color: "rgba(160,230,255,0.12)" },
    audio: { type: "pad", tempo: 0.7 }
  },
  focus: {
    title: "Focus",
    subtitle: "Narrow your attention. Small steps, big results.",
    emoji: "üéØ",
    bg: ["#eaffef","#cbffdc","#9bffb8"],
    particleColor: "#BFFFD1",
    ring: { size: 380, color: "rgba(170,255,200,0.12)" },
    audio: { type: "pulse", tempo: 1.5 }
  },
  warm: {
    title: "Warm",
    subtitle: "Cozy and steady ‚Äî a soft hug in color form.",
    emoji: "üíõ",
    bg: ["#fff0d6","#ffd9b2","#ffb88a"],
    particleColor: "#FFCFA0",
    ring: { size: 480, color: "rgba(255,180,110,0.14)" },
    audio: { type: "fire", tempo: 0.95 }
  }
};

const quotes = [
  "Small comforts can change a whole day.",
  "Breathe in good vibes, breathe out doubt.",
  "Focus is a muscle ‚Äî train it gently.",
  "Kindness is a warm light that never dims.",
  "Create a moment of calm in your pocket."
];

let state = {
  mood: localStorage.getItem("mood-studio-mood") || "happy",
  intensity: Number(localStorage.getItem("mood-studio-intensity") || 60),
  musicOn: localStorage.getItem("mood-studio-musicOn") === "true" ? true : false,
  autosave: true
};

/* ========== DOM refs ========== */
const musicToggle = document.getElementById("musicToggle");
const intensityInput = document.getElementById("intensity");
const intensityVal = document.getElementById("intensityVal");
const typewriterEl = document.getElementById("typewriter");
const moodTitle = document.getElementById("moodTitle");
const moodSub = document.getElementById("moodSub");
const bigEmoji = document.getElementById("bigEmoji");
const quoteArea = document.getElementById("quoteArea");
const greetingEl = document.getElementById("greeting");
const avatarEl = document.getElementById("avatar");
const usernameEl = document.getElementById("username");
const moodGrid = document.getElementById("moodGrid");
const particlesCanvas = document.getElementById("particlesCanvas");
const ringsContainer = document.getElementById("ringsContainer");
const card = document.getElementById("card");
const saveBtn = document.getElementById("saveBtn");
const restoreBtn = document.getElementById("restoreBtn");
const randomBtn = document.getElementById("randomBtn");

/* ========== Time greeting ========== */
function setGreeting(){
  const hr = new Date().getHours();
  let text = "Welcome";
  if(hr < 12) text = "Good morning";
  else if(hr < 17) text = "Good afternoon";
  else text = "Good evening";
  greetingEl.textContent = text;
}
setGreeting();

/* ========== Typewriter ========== */
function typewriter(text, el, speed=28){
  el.textContent = "";
  let i=0;
  const t = setInterval(()=>{ el.textContent += text[i] || ""; i++; if(i>text.length) clearInterval(t); }, speed);
}

/* ========== Particles System (Canvas) ========== */
const dpi = window.devicePixelRatio || 1;
const ctx = particlesCanvas.getContext("2d");
let particles = [];
function resizeCanvas(){
  particlesCanvas.width = Math.max(1, particlesCanvas.clientWidth) * dpi;
  particlesCanvas.height = Math.max(1, particlesCanvas.clientHeight) * dpi;
  ctx.setTransform(dpi,0,0,dpi,0,0);
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

function initParticles(count=80, color="#FFD77A"){
  particles = [];
  const w = particlesCanvas.clientWidth, h = particlesCanvas.clientHeight;
  for(let i=0;i<count;i++){
    particles.push({
      x: Math.random()*w,
      y: Math.random()*h,
      vx: (Math.random()*1.4-0.7),
      vy: (Math.random()*1.2-0.6),
      size: 1 + Math.random()*3,
      alpha: 0.12 + Math.random()*0.6,
      hue: color
    });
  }
}
function drawParticles(){
  ctx.clearRect(0,0,particlesCanvas.width,particlesCanvas.height);
  for(const p of particles){
    p.x += p.vx * (state.intensity/60);
    p.y += p.vy * (state.intensity/60);
    // wrap
    if(p.x < -20) p.x = particlesCanvas.clientWidth + 20;
    if(p.x > particlesCanvas.clientWidth + 20) p.x = -20;
    if(p.y < -20) p.y = particlesCanvas.clientHeight + 20;
    if(p.y > particlesCanvas.clientHeight + 20) p.y = -20;
    ctx.beginPath();
    const grad = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.size*6);
    grad.addColorStop(0, hexToRgba(p.hue, p.alpha));
    grad.addColorStop(1, hexToRgba(p.hue, 0));
    ctx.fillStyle = grad;
    ctx.arc(p.x, p.y, p.size*3, 0, Math.PI*2);
    ctx.fill();
  }
}

/* helper to convert hex to rgba - but here we support hex or already rgba string */
function hexToRgba(hex, a){
  // if looks like rgba
  if(typeof hex === "string" && hex.indexOf("rgba")===0) {
    return hex.replace("rgba(","rgba(").replace(")","").replace(/\s/g,"");
  }
  // else assume hex color like #ffd77a
  const c = hex.replace("#",""), r=parseInt(c.substring(0,2),16), g=parseInt(c.substring(2,4),16), b=parseInt(c.substring(4,6),16);
  return `rgba(${r},${g},${b},${a})`;
}

/* ========== Rings (DOM) ========== */
function drawRings(spec){
  ringsContainer.innerHTML = "";
  // create layered rings
  for(let i=0;i<4;i++){
    const d = document.createElement("div");
    const size = spec.size * (1 + i*0.22);
    d.className = "ring";
    d.style.width = size + "px";
    d.style.height = size + "px";
    d.style.left = `calc(50% - ${size/2}px)`;
    d.style.top = `calc(50% - ${size/2}px)`;
    d.style.background = `radial-gradient(circle, ${spec.color}, transparent 40%)`;
    d.style.opacity = 0.6 - i*0.12;
    d.style.transform = `scale(${1 + i*0.04})`;
    d.style.transition = "all 900ms ease";
    ringsContainer.appendChild(d);
  }
}

/* ========== Audio: WebAudio simple mood synths ========== */
const AudioContext = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;
let masterGain = null;
let currentNodes = [];

function ensureAudio(){
  if(!audioCtx) {
    audioCtx = new AudioContext();
    masterGain = audioCtx.createGain();
    masterGain.gain.value = 0.0001;
    masterGain.connect(audioCtx.destination);
    // small ramp
    masterGain.gain.linearRampToValueAtTime(0.4, audioCtx.currentTime + 0.6);
  }
}

function stopAudio(){
  if(!audioCtx) return;
  currentNodes.forEach(n=>{
    try{ n.stop && n.stop(); }catch(e){}
    try{ n.disconnect && n.disconnect(); }catch(e){}
  });
  currentNodes = [];
}

function playMoodAudio(moodSpec){
  if(!state.musicOn) return;
  ensureAudio();
  stopAudio();
  const t = moodSpec.audio.tempo;
  // simple patterns depending on type
  if(moodSpec.audio.type === "pluck"){
    // create repeating pluck sequence
    const now = audioCtx.currentTime;
    for(let i=0;i<6;i++){
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      const f = 320 + (Math.random()*80) + i*6;
      osc.type = "sine";
      osc.frequency.value = f;
      gain.gain.value = 0;
      osc.connect(gain);
      gain.connect(masterGain);
      osc.start(now + i * (0.5 / t));
      gain.gain.setValueAtTime(0, now + i*(0.5 / t));
      gain.gain.linearRampToValueAtTime(0.06, now + i*(0.5 / t) + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.0002, now + i*(0.5 / t) + 0.8);
      osc.stop(now + i*(0.5 / t) + 1.0);
      currentNodes.push(osc);
    }
    // loop by scheduling new batch after some time
    setTimeout(()=> { if(state.musicOn) playMoodAudio(moodSpec); }, 1200 / t);
  } else if(moodSpec.audio.type === "pad"){
    const now = audioCtx.currentTime;
    // two slow detuned oscillators with slow gain movement
    const o1 = audioCtx.createOscillator();
    const o2 = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o1.type = "sine"; o2.type = "sine";
    o1.frequency.value = 220; o2.frequency.value = 224;
    g.gain.value = 0.001;
    o1.connect(g); o2.connect(g);
    g.connect(masterGain);
    o1.start(now); o2.start(now);
    // gentle swell
    g.gain.linearRampToValueAtTime(0.2 * (state.intensity/60), now + 0.8);
    g.gain.linearRampToValueAtTime(0.045 * (state.intensity/60), now + 6);
    currentNodes.push(o1,o2,g);
    // stop after some time and restart if still on
    setTimeout(()=>{ try{ o1.stop(); o2.stop(); }catch(e){} if(state.musicOn) playMoodAudio(moodSpec); }, 7000);
  } else if(moodSpec.audio.type === "pulse"){
    // rhythmic pulse using oscillator + gain LFO
    const now = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    osc.type = "sawtooth";
    osc.frequency.value = 110;
    const g = audioCtx.createGain();
    g.gain.value = 0;
    osc.connect(g); g.connect(masterGain);
    osc.start(now);
    // create pulses
    for(let i=0;i<8;i++){
      const start = now + i*(0.45 / t);
      g.gain.setValueAtTime(0.0001, start);
      g.gain.linearRampToValueAtTime(0.16 * (state.intensity/60), start + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0002, start + 0.32);
    }
    currentNodes.push(osc);
    setTimeout(()=>{ try{ osc.stop(); }catch(e){} if(state.musicOn) playMoodAudio(moodSpec); }, 3600 / t);
  } else if(moodSpec.audio.type === "fire"){
    // gentle noise + sine
    const now = audioCtx.currentTime;
    const bufferSize = 2 * audioCtx.sampleRate;
    const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const output = noiseBuffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) { output[i] = (Math.random()*2-1) * 0.25; }
    const noise = audioCtx.createBufferSource();
    noise.buffer = noiseBuffer;
    const noiseGain = audioCtx.createGain();
    noiseGain.gain.value = 0.025 * (state.intensity/60);
    noise.connect(noiseGain); noiseGain.connect(masterGain);
    noise.start(now);
    currentNodes.push(noise, noiseGain);
    // add low sine
    const osc = audioCtx.createOscillator();
    osc.type = "sine"; osc.frequency.value = 120;
    const g = audioCtx.createGain(); g.gain.value = 0.0001;
    osc.connect(g); g.connect(masterGain);
    osc.start(now);
    g.gain.linearRampToValueAtTime(0.12*(state.intensity/60), now+0.6);
    currentNodes.push(osc,g);
    setTimeout(()=>{ try{ noise.stop(); osc.stop(); }catch(e){} if(state.musicOn) playMoodAudio(moodSpec); }, 7000);
  }
}

/* ========== Interactivity & UI update ========== */
function applyMood(moodKey, skipAudio=false){
  const spec = moods[moodKey];
  // update title/sub
  moodTitle.textContent = `Mood: ${spec.title}`;
  moodSub.textContent = spec.subtitle;
  bigEmoji.textContent = spec.emoji;
  avatarEl.textContent = spec.emoji;
  intensityVal.textContent = state.intensity;
  // typewriter message
  typewriter(`${spec.subtitle}`, typewriterEl, 18);
  // background gradient
  const bg = `radial-gradient(circle at 10% 20%, ${spec.bg[0]} 0%, transparent 12%),
              radial-gradient(circle at 90% 80%, ${spec.bg[1]} 0%, transparent 14%),
              linear-gradient(180deg, ${spec.bg[0]} 0%, ${spec.bg[2]} 40%, ${spec.bg[2]} 100%)`;
  document.documentElement.style.background = bg;
  // particles color
  initParticles(Math.max(40, 28 + Math.floor(state.intensity/2)), spec.particleColor);
  // rings
  drawRings(spec.ring);
  // glow ring element reposition
  const decor = document.getElementById("decorRing");
  decor.style.background = `radial-gradient(circle, ${spec.bg[2]}, transparent 46%)`;
  // update avatar shadow
  avatarEl.style.boxShadow = `0 14px 40px ${spec.ring.color}, inset 0 -6px 16px rgba(0,0,0,0.02)`;
  // audio
  if(!skipAudio){
    if(state.musicOn) {
      playMoodAudio(spec);
    } else {
      stopAudio();
    }
  }
  // random quote
  quoteArea.textContent = quotes[Math.floor(Math.random()*quotes.length)];
  // save if autosave
  if(state.autosave){
    localStorage.setItem("mood-studio-mood", moodKey);
    localStorage.setItem("mood-studio-intensity", state.intensity);
    localStorage.setItem("mood-studio-musicOn", state.musicOn);
  }
}

/* ========== Attach event listeners ========== */
document.querySelectorAll(".mood-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const m = btn.getAttribute("data-mood");
    state.mood = m;
    applyMood(m);
    // brief emoji pop
    btn.animate([{transform:"scale(1)"},{transform:"scale(1.06)"},{transform:"scale(1)"}],{duration:350,easing:"ease-out"});
  });
});

// intensity
intensityInput.value = state.intensity;
intensityVal.textContent = state.intensity;
intensityInput.addEventListener("input", (e)=>{
  state.intensity = Number(e.target.value);
  intensityVal.textContent = state.intensity;
  // reapply current mood for visual update
  applyMood(state.mood, true);
});

// music toggle
function setMusicToggleUI(){
  if(state.musicOn) musicToggle.classList.add("on"); else musicToggle.classList.remove("on");
  musicToggle.setAttribute("aria-checked", state.musicOn ? "true":"false");
}
setMusicToggleUI();
musicToggle.addEventListener("click", async ()=>{
  // resume AudioContext on first user gesture
  if(!audioCtx) {
    try{ await (new (window.AudioContext || window.webkitAudioContext)()).resume(); }catch(e){}
  }
  state.musicOn = !state.musicOn;
  setMusicToggleUI();
  if(state.musicOn){
    ensureAudio();
    playMoodAudio(moods[state.mood]);
  } else {
    stopAudio();
  }
  localStorage.setItem("mood-studio-musicOn", state.musicOn);
});

// save & restore
saveBtn.addEventListener("click", ()=>{
  localStorage.setItem("mood-studio-mood", state.mood);
  localStorage.setItem("mood-studio-intensity", state.intensity);
  localStorage.setItem("mood-studio-musicOn", state.musicOn);
  alert("Mood saved locally.");
});
restoreBtn.addEventListener("click", ()=>{
  const m = localStorage.getItem("mood-studio-mood");
  const intensity = Number(localStorage.getItem("mood-studio-intensity") || state.intensity);
  const musicOn = localStorage.getItem("mood-studio-musicOn") === "true";
  if(m) {
    state.mood = m; state.intensity = intensity; state.musicOn = musicOn;
    intensityInput.value = state.intensity; intensityVal.textContent = state.intensity;
    setMusicToggleUI();
    applyMood(state.mood);
  } else alert("No saved mood found.");
});

// random
randomBtn.addEventListener("click", ()=>{
  const keys = Object.keys(moods);
  const pick = keys[Math.floor(Math.random()*keys.length)];
  state.mood = pick;
  applyMood(pick);
});

// on load apply stored mood
applyMood(state.mood);

/* ========== Animation loop ========== */
let last = 0;
function animate(ts){
  const elapsed = ts - last;
  last = ts;
  drawParticles();
  requestAnimationFrame(animate);
}
requestAnimationFrame(animate);

/* ========== Small accessibility / keyboard support ========== */
document.addEventListener("keydown",(e)=>{
  if(e.key === "1") { document.querySelector('[data-mood="happy"]').click(); }
  if(e.key === "2") { document.querySelector('[data-mood="calm"]').click(); }
  if(e.key === "3") { document.querySelector('[data-mood="focus"]').click(); }
  if(e.key === "4") { document.querySelector('[data-mood="warm"]').click(); }
});

/* ========== Utility: small animation for rings on click ========== */
ringsContainer.addEventListener("click",(ev)=>{
  const ripple = document.createElement("div");
  ripple.style.position="absolute";
  ripple.style.left = ev.offsetX + "px";
  ripple.style.top = ev.offsetY + "px";
  ripple.style.width="10px"; ripple.style.height="10px";
  ripple.style.borderRadius="999px";
  ripple.style.background = "rgba(255,255,255,0.08)";
  ripple.style.transform = "translate(-50%,-50%)";
  ripple.style.pointerEvents = "none";
  ripple.style.transition = "all 700ms ease";
  ringsContainer.appendChild(ripple);
  requestAnimationFrame(()=>{ ripple.style.width="420px"; ripple.style.height="420px"; ripple.style.opacity="0"; });
  setTimeout(()=> ripple.remove(),800);
});

/* ========== Extra niceties: small floating ambient movement ========== */
let floatAngle = 0;
function floatGlow(){
  floatAngle += 0.01;
  const rings = document.querySelectorAll(".ring");
  rings.forEach((r,i)=>{
    r.style.transform = `translateX(${Math.sin(floatAngle + i)*6}px) scale(${1 + i*0.02})`;
  });
  requestAnimationFrame(floatGlow);
}
floatGlow();

/* ========== Initialize particle color based on current mood ========== */
initParticles(60, moods[state.mood].particleColor);

/* ========== Prevent autoplay blocking: attach first touch to resume audio if needed ========== */
document.body.addEventListener("pointerdown", async ()=>{
  if(audioCtx && audioCtx.state === "suspended") {
    try{ await audioCtx.resume(); }catch(e){}
  }
}, { once:true });

/* ========== Small helper: keep the UI snappy if localStorage cleared externally ========== */
window.addEventListener("storage", (e)=>{
  if(e.key && e.key.startsWith("mood-studio")) {
    // reapply stored values
    const m = localStorage.getItem("mood-studio-mood");
    if(m) { state.mood = m; state.intensity = Number(localStorage.getItem("mood-studio-intensity")||60); state.musicOn = localStorage.getItem("mood-studio-musicOn")==="true"; intensityInput.value = state.intensity; intensityVal.textContent = state.intensity; setMusicToggleUI(); applyMood(state.mood); }
  }
});

/* ========== Done! ========== */
</script>
</body>
</html>
